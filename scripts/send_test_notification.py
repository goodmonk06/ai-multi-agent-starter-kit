#!/usr/bin/env python3
"""
Test Notification Sender - DRYé€šçŸ¥ã®ãƒ†ã‚¹ãƒˆ

ä½¿ã„æ–¹:
    python scripts/send_test_notification.py

æ©Ÿèƒ½:
- DRY_RUN=true ã®å ´åˆ: storage/notifications.jsonl ã«è¨˜éŒ²
- DRY_RUN=false ã®å ´åˆ: å®Ÿéš›ã«Email/Slackã«é€ä¿¡
"""

import asyncio
from datetime import datetime
from core.notifier import Notifier, NotifierConfig


async def main():
    """ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"""
    print("=" * 60)
    print("ğŸ“§ Test Notification Sender")
    print("=" * 60)
    print()

    # Notifierã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
    config = NotifierConfig()
    notifier = Notifier(config)

    print(f"DRY_RUN: {config.dry_run}")
    print(f"Channels: {config.channels or ['(none configured)']}")
    print()

    if config.dry_run:
        print("ğŸ”µ DRY_RUN MODE: Notifications will be saved to notifications.jsonl")
        print()
    else:
        print("ğŸ”´ REAL MODE: Notifications will be sent to configured channels")
        print()
        print("âš ï¸  WARNING: This will send actual notifications!")
        confirm = input("Continue? (yes/no): ")
        if confirm.lower() != "yes":
            print("Cancelled.")
            return

    # ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
    subject = f"Test Notification - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    body = """
This is a test notification from AI Multi-Agent Starter Kit.

Runner Status:
- Mode: DRY_RUN
- Jobs: heartbeat, cleanup, demo
- Status: Running

If you're seeing this, your notification system is working correctly!

---
Generated by scripts/send_test_notification.py
    """.strip()

    print("Sending test notification...")
    print()
    print(f"Subject: {subject}")
    print(f"Body: {body[:100]}...")
    print()

    result = await notifier.send(
        subject=subject,
        body=body,
        test=True,
        sender="send_test_notification.py"
    )

    print("=" * 60)
    print("ğŸ“Š Result")
    print("=" * 60)
    print()

    if config.dry_run:
        print(f"âœ… Notification recorded to: {config.notifications_file}")
        print()
        print("To view the notification:")
        print(f"  cat {config.notifications_file} | jq .")
        print()
        print("To send real notifications:")
        print("  1. Set DRY_RUN=false in .env")
        print("  2. Configure NOTIFY_CHANNELS (e.g., email,slack)")
        print("  3. Configure SMTP_* or SLACK_WEBHOOK_URL")
        print("  4. Run this script again")
    else:
        print("Results:")
        for channel, channel_result in result.get("results", {}).items():
            status = channel_result.get("status", "unknown")
            message = channel_result.get("message", "")

            if status == "success":
                print(f"  âœ… {channel}: {message}")
            else:
                print(f"  âŒ {channel}: {message}")

    print()
    print("=" * 60)


if __name__ == "__main__":
    asyncio.run(main())
