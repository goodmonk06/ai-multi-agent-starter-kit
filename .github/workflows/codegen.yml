name: Code Generation

# コード生成と自動更新のワークフロー
on:
  workflow_dispatch:
    inputs:
      app_type:
        description: 'Application type to generate'
        required: true
        type: choice
        options:
          - care_scheduler
          - sns_auto
          - hr_matching
          - custom
      feature_description:
        description: 'Feature description'
        required: true
        type: string

jobs:
  generate-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Generate code
        env:
          APP_TYPE: ${{ github.event.inputs.app_type }}
          FEATURE_DESC: ${{ github.event.inputs.feature_description }}
        run: |
          echo "Generating code for: $APP_TYPE"
          echo "Feature: $FEATURE_DESC"

          # コード生成ロジック（実際にはLLMを使用）
          python -c "
          import os
          app_type = os.environ['APP_TYPE']
          feature = os.environ['FEATURE_DESC']

          print(f'Generating code for {app_type}...')
          print(f'Feature: {feature}')
          print('Code generation completed')
          "

      - name: Run tests
        run: |
          echo "Running tests..."
          pytest --maxfail=1 --disable-warnings -v || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: Add ${{ github.event.inputs.feature_description }}'
          title: 'Auto-generated: ${{ github.event.inputs.feature_description }}'
          body: |
            ## Auto-generated Code

            This PR was automatically generated by the codegen workflow.

            **App Type**: ${{ github.event.inputs.app_type }}
            **Feature**: ${{ github.event.inputs.feature_description }}

            Please review the generated code before merging.
          branch: codegen/${{ github.event.inputs.app_type }}-${{ github.run_number }}
          delete-branch: true
