name: Nightly Run

# 毎晩自動実行されるワークフロー
on:
  schedule:
    # 毎日午前2時（UTC）に実行
    - cron: '0 2 * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  nightly-tasks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run scheduled care tasks
        run: |
          echo "Running care scheduler nightly tasks..."
          python -c "
          import asyncio
          from core import MemoryStore
          from agents import SchedulerAgent
          from apps.care_scheduler import CareSchedulerApp

          async def main():
              memory = MemoryStore()
              agents = {'scheduler': SchedulerAgent(memory)}
              app = CareSchedulerApp(agents, None, memory)
              print('Care scheduler nightly tasks completed')

          asyncio.run(main())
          "

      - name: Run SNS automation tasks
        run: |
          echo "Running SNS automation nightly tasks..."
          python -c "
          import asyncio
          from core import MemoryStore
          from agents import GeneratorAgent, ComplianceAgent
          from apps.sns_auto import SnsAutoApp

          async def main():
              memory = MemoryStore()
              agents = {
                  'generator': GeneratorAgent(memory),
                  'compliance': ComplianceAgent(memory)
              }
              app = SnsAutoApp(agents, None, memory)
              print('SNS automation nightly tasks completed')

          asyncio.run(main())
          "

      - name: Generate daily report
        run: |
          echo "Generating daily report..."
          python -c "
          import asyncio
          from datetime import datetime

          async def main():
              report = f'''
              Daily Report - {datetime.now().strftime('%Y-%m-%d')}
              ===================================
              - Care scheduler tasks: Completed
              - SNS automation tasks: Completed
              - System health: OK
              '''
              print(report)

          asyncio.run(main())
          "

      - name: Upload results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: nightly-run-results
          path: |
            *.log
            reports/
          retention-days: 30
